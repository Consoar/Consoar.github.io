<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[App Widget Configuration Activity返回值的问题]]></title>
      <url>http://consoar.github.io/2016/10/30/App-Widget-Configuration-Activity%E8%BF%94%E5%9B%9E%E5%80%BC%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<p>Android在官方的SDK中有这么一段话</p>
<p><a href="http://developer.android.com/reference/android/appwidget/AppWidgetManager.html#ACTION_APPWIDGET_CONFIGURE" target="_blank" rel="external">http://developer.android.com/reference/android/appwidget/AppWidgetManager.html#ACTION_APPWIDGET_CONFIGURE</a></p>
<blockquote>
<p>If you return RESULT_OK using Activity.setResult(), the AppWidget will be added, and you will receive an ACTION_APPWIDGET_UPDATE broadcast for this AppWidget. If you returnRESULT_CANCELED, the host will cancel the add and not display this AppWidget, and you will receive a ACTION_APPWIDGET_DELETED broadcast.</p>
</blockquote>
<p>大概就是需要setResult来告诉widget是否设置成功，使用如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Intent resultValue = <span class="keyword">new</span> Intent();  </div><div class="line">resultValue.putExtra(AppWidgetManager.EXTRA_APPWIDGET_ID, mAppWidgetId);  </div><div class="line">setResult(RESULT_CANCELED, resultValue);  </div><div class="line">finish();</div></pre></td></tr></table></figure>
<p>但是啊，坑爹的是</p>
<blockquote>
<p>and you will receive a ACTION_APPWIDGET_DELETED broadcast.</p>
</blockquote>
<p>这句，我在AppWidgetProvider根本就没收到这个广播啊！设置RESULT_OK时也没收到ACTION_APPWIDGET_UPDATE的广播！</p>
<p>后来搜索了下，我的解决办法就是：自己发广播！</p>
<p>PS：</p>
<p>1.我看了看官方API DEMOS里的那个样例也是没有收到相应的广播，感觉就压根没发送啊。。。</p>
<p>2.我看这貌似是个BUG，详见<a href="http://code.google.com/p/android/issues/detail?id=2539" target="_blank" rel="external">http://code.google.com/p/android/issues/detail?id=2539</a>，很多年前报告过，最近又有人反应RESULT_CANCELED是无法删除Ghost Widget，我试了试，AppWidgetId是会保留，而且在update方法调用时依然是会有该id传入的。。。</p>
<p>3.这是个存在了5年的bug。。。</p>
<p>网上有一些变通的方法</p>
<p><a href="http://www.rinofinazzo.com/blog/2011/12/23/android-phantom-widgets-fix/" target="_blank" rel="external">http://www.rinofinazzo.com/blog/2011/12/23/android-phantom-widgets-fix/</a><br><a href="http://stackoverflow.com/questions/17387191/check-if-a-widget-is-exists-on-homescreen-using-appwidgetid/17387978#17387978" target="_blank" rel="external">http://stackoverflow.com/questions/17387191/check-if-a-widget-is-exists-on-homescreen-using-appwidgetid/17387978#17387978</a></p>
<p>基本思想就是自己标记哪些是Ghost Widget，然后再删除。</p>
]]></content>
    </entry>
    
  
  
</search>
